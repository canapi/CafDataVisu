@{
    ViewBag.Title = "Tableau de bord";
}

<!-- Content Header (Page header) -->
<section class="content-header">
    <h1>
        Tableau de bord
        <small>&nbsp;</small>
    </h1>
    <ol class="breadcrumb">
        <li><a href="@Url.Action("Index", "Home")"><i class="fa fa-dashboard"></i> Accueil</a></li>
        <li class="active">Tableau de bord</li>
    </ol>
</section>

<style>
    iframe {
        border: 0;
        overflow: hidden;
    }
</style>

<section class="content">

    <iframe height="300" width="300" data-tileId="b587c551-8608-44d6-b45d-848d8616398a" data-dashboardId="6616e09f-6165-4c96-b5f0-d255eecfeca8" data-groupId="c29acdcf-23b1-4af1-8764-024b5d2c08ea"></iframe>
    <iframe height="300" width="300" data-tileId="a1c10a8f-e1bf-4e9b-948e-7bebf1a8758b" data-dashboardId="6616e09f-6165-4c96-b5f0-d255eecfeca8" data-groupId="c29acdcf-23b1-4af1-8764-024b5d2c08ea"></iframe>
    <iframe height="300" width="300" data-tileId="6d821a2c-5360-4e79-97b4-31ff9ac1eebd" data-dashboardId="6616e09f-6165-4c96-b5f0-d255eecfeca8" data-groupId="c29acdcf-23b1-4af1-8764-024b5d2c08ea"></iframe>
    
</section>

@section scripts{
    
<script>

    $(document).ready(function () {
        $("iframe[data-tileId]")
            .each(function (index) {
                var frm = $(this)[0];
                var tileId = $(this).data("tileid");
                var dashboardId = $(this).data("dashboardid");
                var groupId = $(this).data("groupid");
                var height = frm.height;
                var width = frm.width;
                $.ajax({
                    url: '/api/PowerBiApi?tileId=' + tileId + '&dashboardId=' + dashboardId + '&groupId=' + groupId,
                    type: 'GET',
                    dataType: 'json',
                    success: function (data) {
                        var jsonObj = JSON.parse(data);
                        frm.onload = function () { postActionLoadTile(frm, jsonObj.accessToken, height, width); }
                        frm.src = jsonObj.tileurl;
                    },
                    error: function (x, y, z) {
                        alert(x + '\n' + y + '\n' + z);
                    }
                });
            });
        // listen for message to receive tile click messages.
        if (window.addEventListener) {
            window.addEventListener("message", receiveMessage, false);
        } else {
            window.attachEvent("onmessage", receiveMessage);
        }
        
    });

    function openPbi(groupId, reportId) {
        // https://app.powerbi.com/groups/c29acdcf-23b1-4af1-8764-024b5d2c08ea/reports/733c6ddf-3e76-4a6f-90ff-3c05e27263a0
        var url = "https://app.powerbi.com/groups/" + groupId + "/reports/" + reportId;
        window.open(url);
    }

    function receiveMessage(event) {
        debugger;
        if (event.data) {
            try {
                messageData = JSON.parse(event.data);
                if (messageData.event === "tileClicked") {
                    window.open(messageData.navigationUrl);
                }
            }
            catch (e) {
                // In a production app, handle exception
            }
        }
    }

    function postActionLoadTile(ifrm, accessToken, height, width) {

        if ("" === accessToken)
            return;

        // construct the push message structure
        var m = { action: "loadTile", accessToken: accessToken, height: height, width: width};
        var message = JSON.stringify(m);

        // push the message.
        ifrm.contentWindow.postMessage(message, "*");
    }
</script>

}